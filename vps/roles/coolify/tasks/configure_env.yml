---
- name: Create local backup directory for credentials
  file:
    path: "{{ playbook_dir }}/.credentials/{{ inventory_hostname }}/coolify"
    state: directory
    mode: "0700"
  delegate_to: localhost
  become: no
  run_once: true

- name: Check if .env file already exists with valid credentials
  shell: |
    if [ ! -f /data/coolify/source/.env ]; then
      echo "missing"
      exit 0
    fi
    if grep -q "^APP_ID=.\+" /data/coolify/source/.env && \
       grep -q "^DB_PASSWORD=.\+" /data/coolify/source/.env && \
       grep -q "^REDIS_PASSWORD=.\+" /data/coolify/source/.env; then
      echo "valid"
    else
      echo "invalid"
    fi
  register: env_status
  changed_when: false

- name: Generate new Coolify credentials
  shell: |
    APP_ID=$(openssl rand -hex 16)
    APP_KEY="base64:$(openssl rand -base64 32)"
    DB_PASSWORD=$(openssl rand -base64 32)
    REDIS_PASSWORD=$(openssl rand -base64 32)
    PUSHER_APP_ID=$(openssl rand -hex 32)
    PUSHER_APP_KEY=$(openssl rand -hex 32)
    PUSHER_APP_SECRET=$(openssl rand -hex 32)
    cat << EOF
    {
      "APP_ID": "$APP_ID",
      "APP_KEY": "$APP_KEY",
      "DB_PASSWORD": "$DB_PASSWORD",
      "REDIS_PASSWORD": "$REDIS_PASSWORD",
      "PUSHER_APP_ID": "$PUSHER_APP_ID",
      "PUSHER_APP_KEY": "$PUSHER_APP_KEY",
      "PUSHER_APP_SECRET": "$PUSHER_APP_SECRET"
    }
    EOF
  register: coolify_credentials_raw
  delegate_to: localhost
  become: no
  run_once: true
  when: env_status.stdout != "valid"

- name: Set credentials fact from generated
  set_fact:
    coolify_credentials: "{{ coolify_credentials_raw.stdout | from_json }}"
  when: env_status.stdout != "valid"

- name: Check if compose files exist
  stat:
    path: "{{ item }}"
  loop:
    - /data/coolify/source/docker-compose.yml
    - /data/coolify/source/docker-compose.prod.yml
  register: compose_files_check

- name: Download Coolify compose files
  get_url:
    url: "{{ item.url }}"
    dest: "{{ item.dest }}"
    mode: "0600"
  loop:
    - { url: "https://cdn.coollabs.io/coolify/docker-compose.yml", dest: "/data/coolify/source/docker-compose.yml" }
    - { url: "https://cdn.coollabs.io/coolify/docker-compose.prod.yml", dest: "/data/coolify/source/docker-compose.prod.yml" }
  when: compose_files_check.results | selectattr('stat.exists', 'equalto', false) | list | length > 0

- name: Download Coolify upgrade script
  get_url:
    url: "https://cdn.coollabs.io/coolify/upgrade.sh"
    dest: /data/coolify/source/upgrade.sh
    mode: "0700"
    force: no

- name: Check if docker-compose.custom.yml exists and get checksum
  stat:
    path: /data/coolify/source/docker-compose.custom.yml
    checksum_algorithm: sha256
  register: existing_custom_compose

- name: Generate docker-compose.custom.yml content in memory
  set_fact:
    expected_custom_compose_content: |
      # Docker Compose override file to disable external port exposure
      services:
        coolify:
          ports: !reset []
        soketi:
          ports: !reset []
  when: not (expose_coolify_ports | default(false))

- name: Calculate expected content checksum
  set_fact:
    expected_checksum: "{{ expected_custom_compose_content | hash('sha256') }}"
  when: not (expose_coolify_ports | default(false))

- name: Determine if custom compose file needs update
  set_fact:
    custom_compose_needs_update: >-
      {{
        not (expose_coolify_ports | default(false)) and (
          not existing_custom_compose.stat.exists or
          existing_custom_compose.stat.checksum != expected_checksum
        )
      }}

- name: Create docker-compose.custom.yml to disable external ports
  copy:
    content: "{{ expected_custom_compose_content }}"
    dest: /data/coolify/source/docker-compose.custom.yml
    mode: "0600"
    backup: yes
  when: custom_compose_needs_update | default(false)
  register: custom_compose_created

- name: Remove docker-compose.custom.yml when external ports are enabled
  file:
    path: /data/coolify/source/docker-compose.custom.yml
    state: absent
  when: expose_coolify_ports | default(false)
  register: custom_compose_removed

- name: Set compose changed fact
  set_fact:
    coolify_compose_changed: "{{ custom_compose_created.changed | default(false) or custom_compose_removed.changed | default(false) }}"

- name: Generate Coolify .env file
  template:
    src: env.j2
    dest: /data/coolify/source/.env
    mode: "0600"
    backup: yes
  when: env_status.stdout != "valid"

- name: Generate Coolify .env backup (local)
  template:
    src: env.j2
    dest: "{{ playbook_dir }}/.credentials/{{ inventory_hostname }}/coolify/.env"
    mode: "0600"
  delegate_to: localhost
  become: no
  when: env_status.stdout != "valid"
