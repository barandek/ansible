---
- name: Create local backup directory for credentials
  file:
    path: "{{ playbook_dir }}/.credentials/{{ inventory_hostname }}/coolify"
    state: directory
    mode: "0700"
  delegate_to: localhost
  become: no
  run_once: true

- name: Check if .env file already exists with valid credentials
  shell: |
    if [ ! -f /data/coolify/source/.env ]; then
      echo "missing"
      exit 0
    fi
    if grep -q "^APP_ID=.\+" /data/coolify/source/.env && \
       grep -q "^DB_PASSWORD=.\+" /data/coolify/source/.env && \
       grep -q "^REDIS_PASSWORD=.\+" /data/coolify/source/.env; then
      echo "valid"
    else
      echo "invalid"
    fi
  register: env_status
  changed_when: false

- name: Generate new Coolify credentials
  shell: |
    set -e
    APP_ID=$(openssl rand -hex 16)
    APP_KEY="base64:$(openssl rand -base64 32)"
    DB_PASSWORD=$(openssl rand -base64 32)
    REDIS_PASSWORD=$(openssl rand -base64 32)
    PUSHER_APP_ID=$(openssl rand -hex 32)
    PUSHER_APP_KEY=$(openssl rand -hex 32)
    PUSHER_APP_SECRET=$(openssl rand -hex 32)
    cat << EOF
    {
      "APP_ID": "$APP_ID",
      "APP_KEY": "$APP_KEY",
      "DB_PASSWORD": "$DB_PASSWORD",
      "REDIS_PASSWORD": "$REDIS_PASSWORD",
      "PUSHER_APP_ID": "$PUSHER_APP_ID",
      "PUSHER_APP_KEY": "$PUSHER_APP_KEY",
      "PUSHER_APP_SECRET": "$PUSHER_APP_SECRET"
    }
    EOF
  register: coolify_credentials_raw
  delegate_to: localhost
  become: no
  run_once: true
  when: env_status.stdout != "valid"
  check_mode: no  # Always run credentials generation, even in check mode

- name: Debug credentials generation output
  debug:
    msg: |
      === CREDENTIALS GENERATION DEBUG ===
      Exit code: {{ coolify_credentials_raw.rc }}
      Stdout: {{ coolify_credentials_raw.stdout }}
      Stderr: {{ coolify_credentials_raw.stderr }}
  when: env_status.stdout != "valid" and coolify_credentials_raw is defined

- name: Set credentials fact from generated
  set_fact:
    coolify_credentials: "{{ coolify_credentials_raw.stdout | from_json }}"
  when: env_status.stdout != "valid" and coolify_credentials_raw.stdout != ""

- name: Fail if credentials generation failed
  fail:
    msg: |
      === CREDENTIALS GENERATION FAILED ===
      Exit code: {{ coolify_credentials_raw.rc }}
      Stdout: "{{ coolify_credentials_raw.stdout }}"
      Stderr: "{{ coolify_credentials_raw.stderr }}"
      
      This usually means openssl is not available or failed to generate random data.
      Please check that openssl is installed on the control host.
  when: env_status.stdout != "valid" and not ansible_check_mode and (coolify_credentials_raw.stdout == "" or coolify_credentials_raw.rc != 0)

- name: Check if compose files exist
  stat:
    path: "{{ item }}"
  loop:
    - /data/coolify/source/docker-compose.yml
    - /data/coolify/source/docker-compose.prod.yml
  register: compose_files_check

- name: Download Coolify compose files
  get_url:
    url: "{{ item.url }}"
    dest: "{{ item.dest }}"
    mode: "0600"
  loop:
    - { url: "https://cdn.coollabs.io/coolify/docker-compose.yml", dest: "/data/coolify/source/docker-compose.yml" }
    - { url: "https://cdn.coollabs.io/coolify/docker-compose.prod.yml", dest: "/data/coolify/source/docker-compose.prod.yml" }
  when: compose_files_check.results | selectattr('stat.exists', 'equalto', false) | list | length > 0

- name: Download Coolify upgrade script
  get_url:
    url: "https://cdn.coollabs.io/coolify/upgrade.sh"
    dest: /data/coolify/source/upgrade.sh
    mode: "0700"
    force: no

- name: Check if docker-compose.custom.yml exists
  stat:
    path: /data/coolify/source/docker-compose.custom.yml
  register: existing_custom_compose

- name: Remove docker-compose.custom.yml (not needed - Traefik routes internally)
  file:
    path: /data/coolify/source/docker-compose.custom.yml
    state: absent
  when: existing_custom_compose.stat.exists
  register: custom_compose_removed

- name: Set compose changed fact
  set_fact:
    coolify_compose_changed: "{{ custom_compose_removed.changed | default(false) }}"

- name: Load existing credentials from .env if valid
  shell: |
    if [ -f /data/coolify/source/.env ]; then
      echo "APP_ID=$(grep '^APP_ID=' /data/coolify/source/.env | cut -d'=' -f2)"
      echo "APP_KEY=$(grep '^APP_KEY=' /data/coolify/source/.env | cut -d'=' -f2)"
      echo "DB_PASSWORD=$(grep '^DB_PASSWORD=' /data/coolify/source/.env | cut -d'=' -f2)"
      echo "REDIS_PASSWORD=$(grep '^REDIS_PASSWORD=' /data/coolify/source/.env | cut -d'=' -f2)"
      echo "PUSHER_APP_ID=$(grep '^PUSHER_APP_ID=' /data/coolify/source/.env | cut -d'=' -f2)"
      echo "PUSHER_APP_KEY=$(grep '^PUSHER_APP_KEY=' /data/coolify/source/.env | cut -d'=' -f2)"
      echo "PUSHER_APP_SECRET=$(grep '^PUSHER_APP_SECRET=' /data/coolify/source/.env | cut -d'=' -f2)"
    fi
  register: existing_env_vars
  when: env_status.stdout == "valid"
  changed_when: false

- name: Parse existing credentials
  set_fact:
    coolify_credentials: "{{ dict(existing_env_vars.stdout_lines | map('split', '=') | list) }}"
  when: env_status.stdout == "valid" and existing_env_vars.stdout_lines | length > 0

- name: Generate Coolify .env file
  template:
    src: env.j2
    dest: /data/coolify/source/.env
    mode: "0600"
    backup: yes
  register: env_file_updated

- name: Generate Coolify .env backup (local)
  template:
    src: env.j2
    dest: "{{ playbook_dir }}/.credentials/{{ inventory_hostname }}/coolify/.env"
    mode: "0600"
  delegate_to: localhost
  become: no
