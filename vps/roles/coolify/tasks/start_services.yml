---
# Start Coolify services
# Unified approach for Docker

- name: Create Coolify network
  shell: docker network create coolify --attachable
  register: network_created
  failed_when: network_created.rc != 0 and "already exists" not in network_created.stderr
  changed_when: network_created.rc == 0

- name: Build compose command
  set_fact:
    compose_cmd: >-
      docker compose
      --env-file /data/coolify/source/.env
      -f /data/coolify/source/docker-compose.yml
      -f /data/coolify/source/docker-compose.prod.yml
      {{ '' if (expose_coolify_ports | default(false)) else '-f /data/coolify/source/docker-compose.custom.yml' }}
      --project-directory /data/coolify/source

- name: Validate compose configuration
  shell: "{{ compose_cmd }} config --quiet"
  register: compose_validation
  failed_when: compose_validation.rc != 0
  changed_when: false

- name: Fail if compose validation failed
  fail:
    msg: |
      === COMPOSE VALIDATION FAILED ===
      {{ compose_validation.stderr | default('Unknown error') }}
  when: compose_validation.rc != 0

- name: Check current Coolify state
  shell: "{{ compose_cmd }} ps -q"
  register: coolify_running
  changed_when: false
  failed_when: false

- name: Determine if services need update
  set_fact:
    coolify_needs_update: >-
      {{
        (coolify_compose_changed | default(false)) or
        (coolify_running.stdout | length == 0)
      }}

- name: Start Coolify services
  shell: |
    {{ compose_cmd }} up -d {{ '--force-recreate' if (coolify_compose_changed | default(false)) else '' }} --remove-orphans
  args:
    chdir: /data/coolify/source
  when: coolify_needs_update
  register: coolify_started

- name: Wait for Coolify to start
  pause:
    seconds: 10
    prompt: "Waiting for Coolify services to start up..."
  when: coolify_started.changed | default(false)