---
- name: Create Coolify network
  command: docker network create coolify --attachable
  register: network_created
  failed_when: network_created.rc != 0 and "already exists" not in network_created.stderr
  changed_when: network_created.rc == 0
  tags: [coolify]

- name: Check current Coolify state
  command: docker compose -f /data/coolify/source/docker-compose.yml -f /data/coolify/source/docker-compose.prod.yml ps -q
  args:
    chdir: /data/coolify/source
  register: coolify_running
  changed_when: false
  failed_when: false
  tags: [coolify]

- name: Determine if services need update
  set_fact:
    coolify_needs_update: "{{ (coolify_compose_changed | default(false)) or (coolify_running.stdout | length == 0) }}"
  tags: [coolify]

- name: Stop Coolify services if configuration changed
  command: docker compose -f /data/coolify/source/docker-compose.yml -f /data/coolify/source/docker-compose.prod.yml down
  args:
    chdir: /data/coolify/source
  when: coolify_compose_changed | default(false)
  tags: [coolify]

- name: Start Coolify services
  command: docker compose --env-file /data/coolify/source/.env -f /data/coolify/source/docker-compose.yml -f /data/coolify/source/docker-compose.prod.yml up -d --remove-orphans
  args:
    chdir: /data/coolify/source
  when: coolify_needs_update
  register: coolify_started
  tags: [coolify]

- name: Wait for Coolify to start
  pause:
    seconds: 10
    prompt: "Waiting for Coolify services to start up..."
  when: coolify_started.changed | default(false)
  tags: [coolify]