---
- name: Debug firewall configuration
  debug:
    msg: |
      === FIREWALL CONFIGURATION DEBUG ===
      Server Role: {{ server_role }}
      Expose Coolify Ports: {{ expose_coolify_ports | default(false) }}
      Total firewall rules: {{ firewall_rules | length }}
      
      Rules:
      {% for rule in firewall_rules %}
      - {{ rule.port }}/{{ rule.proto }}: {{ rule.comment }}
      {% endfor %}
    verbosity: 1

- name: Update libnftables packages to fix compatibility issues
  dnf:
    name:
      - libnftnl
      - nftables
    state: latest

- name: Install firewalld package
  dnf:
    name: firewalld
    state: present

- name: Ensure firewalld service is started and enabled
  systemd:
    name: firewalld
    enabled: yes
    state: started

- name: Ensure SSH service is always allowed (prevent lockout)
  firewalld:
    zone: public
    service: ssh
    permanent: yes
    state: enabled
    immediate: yes

- name: Add firewall rules from configuration
  firewalld:
    zone: public
    port: "{{ item.port }}/{{ item.proto }}"
    permanent: yes
    state: enabled
    immediate: yes
  loop: "{{ firewall_rules }}"

- name: Reload firewalld to apply all rules
  command: firewall-cmd --reload

- name: Display firewalld status
  command: firewall-cmd --list-all --zone=public
  register: firewalld_status_output
  changed_when: false

- name: Show firewalld configuration summary
  debug:
    msg: |
      === FIREWALLD FIREWALL CONFIGURATION ===
      {% for line in firewalld_status_output.stdout_lines %}
      {{ line }}
      {% endfor %}

      Configuration Summary:
      - Total rules configured: {{ firewall_rules | length }}
      - Server role: {{ server_role }}
      - Expose Coolify Ports: {{ expose_coolify_ports | default(false) }}
