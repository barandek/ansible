# =============================================================================
# OpenVPN Server Configuration
# =============================================================================
# Purpose: Split-tunnel VPN for Docker services access
# Network: {{ openvpn_network }}/{{ openvpn_netmask }} (VPN subnet)
# Port: {{ openvpn_port }}/{{ openvpn_proto }}
# =============================================================================
# Generated by Ansible - DO NOT EDIT MANUALLY
# =============================================================================

# Protocol and Port Configuration
proto {{ openvpn_proto }}                    # UDP for better performance
port {{ openvpn_port }}                      # OpenVPN listening port
dev tun                                       # Use TUN device for IP routing

# VPN Network Configuration
server {{ openvpn_network }} {{ openvpn_netmask }}  # VPN subnet and mask
topology subnet                               # Use subnet topology (recommended)

# Certificate and Key Authentication
ca {{ ca_cert_file }}                         # Certificate Authority certificate
cert {{ server_cert_file }}                   # Server certificate
key {{ server_key_file }}                     # Server private key
dh {{ dh_param_file }}                        # Diffie-Hellman parameters
tls-auth {{ ta_key_file }} 0                  # TLS authentication key (server side)

# Security and Encryption Settings
cipher AES-256-GCM                            # Strong encryption cipher
auth SHA256                                   # HMAC authentication algorithm
tls-version-min 1.2                           # Minimum TLS version for security

# Split-Tunnel Routing Configuration
# Only route Docker network traffic through VPN
{% if docker_networks is defined and docker_networks | length > 0 %}
{% for network in docker_networks %}
push "route {{ network | ansible.utils.ipaddr('network') }} {{ network | ansible.utils.ipaddr('netmask') }}"
{% endfor %}
{% else %}
push "route 172.17.0.0 255.255.0.0"           # Default Docker bridge network
push "route 172.18.0.0 255.255.0.0"           # Additional Docker network
{% endif %}

# DNS Configuration
# Split-tunnel: Clients use local DNS (no DNS push)
# Full-tunnel: Uncomment below to push VPN DNS servers
# {% for dns in openvpn_dns_servers %}
# push "dhcp-option DNS {{ dns }}"
# {% endfor %}

# Client Connection Management
client-to-client                              # Allow clients to communicate
keepalive 10 120                             # Keepalive packets (10s interval, 120s timeout)
max-clients 10                                # Maximum concurrent clients

# Security Hardening
user nobody                                   # Drop privileges after startup
{% if ansible_os_family == "RedHat" %}
group nobody                                  # Group for RedHat systems
{% else %}
group nogroup                                  # Group for Debian systems
{% endif %}

# Connection Persistence
persist-key                                   # Don't re-read key files on restart
persist-tun                                   # Don't close and reopen TUN device

# Logging Configuration
status {{ status_file }}                      # Status file location
log-append {{ log_file }}                     # Append to log file
verb 3                                        # Log verbosity (0=quiet, 4=verbose)
