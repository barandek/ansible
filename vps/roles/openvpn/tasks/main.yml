---
- name: Install OpenVPN and Easy-RSA
  package:
    name:
      - openvpn
      - easy-rsa
    state: present

- name: Create directories
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ openvpn_config_dir }}"
    - "{{ client_cert_dir }}"
    - /var/log/openvpn

- name: Get Docker network info
  shell: docker network inspect bridge --format '{% raw %}{{range .IPAM.Config}}{{.Subnet}} {{end}}{% endraw %}' 2>/dev/null
  register: docker_networks_raw
  failed_when: false
  changed_when: false

- name: Set Docker networks fact
  set_fact:
    docker_networks: "{{ docker_networks_raw.stdout.split() | default(['172.17.0.0/16', '172.18.0.0/16']) }}"

- name: Setup PKI
  include_tasks: pki.yml

- name: Configure server
  include_tasks: server.yml

- name: Configure firewall
  include_tasks: firewall.yml

- name: Start OpenVPN
  systemd:
    name: "{{ openvpn_service_name }}"
    state: started
    enabled: yes

- name: Generate clients
  include_tasks: clients.yml
  when: openvpn_users | selectattr('state', 'equalto', 'active') | list | length > 0

- name: Download configs
  include_tasks: download_configs.yml
  when: openvpn_users | selectattr('state', 'equalto', 'active') | list | length > 0
